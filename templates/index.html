<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Flow Graph Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <header class="header">
        <h1>Control Flow Graph Generator</h1>
        <p>Generate and modify control flow graphs with ease</p>
    </header>

    <div class="container">
        <!-- Input Section -->
        <div class="card">
            <form id="inputForm" class="input-container">
                <textarea 
                    id="userInput" 
                    placeholder="Describe the control flow you want to generate..."
                    required
                ></textarea>
                <div class="button-group">
                    <button type="submit" class="button button-primary">
                        Generate Graph
                    </button>
                    <button type="button" class="button button-secondary" onclick="clearHistory()">
                        Clear History
                    </button>
                </div>
            </form>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Generating graph...</p>
        </div>

        <!-- Graph Output Section -->
        <div class="card">
            <div class="graph-container">
                <div id="graphOutput"></div>
                
                <!-- Metrics Section -->
                <div id="metricsOutput" class="metrics-container">
                    <h3>Graph Metrics</h3>
                    <div class="metrics-grid">
                        <!-- Metrics will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Feedback Section -->
            <div id="feedbackContainer" class="feedback-container" style="display: none;">
                <h3>Provide Feedback for Graph Repair</h3>
                <div class="input-container">
                    <textarea 
                        id="feedbackInput" 
                        placeholder="Describe what needs to be fixed or improved..."
                    ></textarea>
                </div>
                <button onclick="submitFeedback()" class="button button-primary">
                    Submit Feedback
                </button>
            </div>
        </div>

        <!-- Chat History Section -->
        <div class="card">
            <h3>Chat History</h3>
            <div id="chatHistory" class="chat-history">
                <!-- Chat messages will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        function updateUI(data) {
            // Hide loading indicator
            $('#loading').hide();
            
            // Update graph image
            if (data.cfg_image) {
                $('#graphOutput').html(`<img src="data:image/png;base64,${data.cfg_image}" alt="Control Flow Graph">`);
                $('#feedbackContainer').show();
            }
            
            // Update metrics
            if (data.metrics) {
                let metricsHtml = '<div class="metrics-grid">';
                for (const [key, value] of Object.entries(data.metrics)) {
                    metricsHtml += `
                        <div class="metric-item">
                            <div class="metric-value">${value}</div>
                            <div class="metric-label">${key}</div>
                        </div>`;
                }
                metricsHtml += '</div>';
                $('#metricsOutput').html(`<h3>Graph Metrics</h3>${metricsHtml}`);
            }
            
            // Update chat history
            if (data.chat_history) {
                let chatHtml = '';
                data.chat_history.forEach(chat => {
                    const messageClass = chat.type === 'user' ? 'user-message' : 'assistant-message';
                    chatHtml += `
                        <div class="chat-message ${messageClass}">
                            <strong>${chat.type}:</strong> ${chat.content}
                        </div>`;
                });
                $('#chatHistory').html(chatHtml);
            }
        }

        $('#inputForm').submit(function(e) {
            e.preventDefault();
            const userInput = $('#userInput').val();
            
            // Show loading indicator
            $('#loading').show();
            
            $.ajax({
                url: '/generate',
                method: 'POST',
                data: { user_input: userInput },
                success: function(data) {
                    updateUI(data);
                    $('#userInput').val('');
                },
                error: function(xhr, status, error) {
                    $('#loading').hide();
                    alert('Error: ' + error);
                }
            });
        });

        function submitFeedback() {
            const feedback = $('#feedbackInput').val();
            
            // Show loading indicator
            $('#loading').show();
            
            $.ajax({
                url: '/repair',
                method: 'POST',
                data: { feedback: feedback },
                success: function(data) {
                    updateUI(data);
                    $('#feedbackInput').val('');
                },
                error: function(xhr, status, error) {
                    $('#loading').hide();
                    alert('Error: ' + error);
                }
            });
        }

        function clearHistory() {
            $.ajax({
                url: '/clear',
                method: 'POST',
                success: function() {
                    location.reload();
                },
                error: function(xhr, status, error) {
                    alert('Error: ' + error);
                }
            });
        }
    </script>
</body>
</html>
